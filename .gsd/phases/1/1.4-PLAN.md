---
phase: 1
plan: 4
wave: 3
depends_on: [3]
files_modified: [app/api/confidence-coach/session/route.js, app/components/confidence-coach/ConfidenceCoachUI.jsx, models/User.js]
autonomous: true

must_haves:
  truths:
    - "API route /api/confidence-coach/session exists and accepts POST requests"
    - "User stats are updated upon successful session save"
    - "ConfidenceCoachUI triggers a fire-and-forget save on session end"
  artifacts:
    - "app/api/confidence-coach/session/route.js"
---

# Plan 1.4: Session Persistence API and Frontend Trigger

<objective>
Purpose: To create the backend infrastructure to save a Confidence Coach session and update the user's aggregate statistics, and connect the frontend UI to this endpoint.
Output: A secured API route storing UserAttempts and updating User models, plus the frontend `fetch` call.
</objective>

<context>
Load for context:
- app/components/confidence-coach/ConfidenceCoachUI.jsx
- models/User.js (and review its existing stats structures)
</context>

<tasks>

<task type="auto">
  <name>Ensure User model supports confidenceCoachStats</name>
  <files>models/User.js</files>
  <action>
    Ensure the `User` schema has a `confidenceCoachStats` nested object.
    It should include: `sessionsCompleted` (Number, default 0), `voiceTrainingMinutes` (Number, default 0), `averageScore` (Number, default 0), and `lastSessionDate` (Date).
    AVOID: Overwriting existing models. Just add the new field if it doesn't already exist.
  </action>
  <verify>grep -q "confidenceCoachStats" models/User.js</verify>
  <done>Schema includes confidenceCoachStats structure.</done>
</task>

<task type="auto">
  <name>Create Session Save API Route</name>
  <files>app/api/confidence-coach/session/route.js</files>
  <action>
    Create a `POST` handler.
    Authenticate the request using `import { authenticate } from '@/lib/auth'` or the equivalent project standard.
    Connect to the DB via `connectDB()`.
    Write one `UserAttempt` document with the request payload, adding `user: user._id`.
    Update the `User` document: increment `confidenceCoachStats.sessionsCompleted`, add `timeTaken / 60` to `voiceTrainingMinutes`, recalculate `averageScore`, and set `lastSessionDate = new Date()`.
    Return `{ success: true, sessionSaved: true }`.
    AVOID: Complex score averaging logic if simpler incremental math works; ensure edge case of 0 prior sessions is handled.
  </action>
  <verify>curl -s -X POST http://localhost:3000/api/confidence-coach/session -i | grep -E "401|200"</verify>
  <done>Route handles authenticated POST requests, saves attempts, and updates user stats.</done>
</task>

<task type="auto">
  <name>Implement Fire-and-Forget Save Call</name>
  <files>app/components/confidence-coach/ConfidenceCoachUI.jsx</files>
  <action>
    Import your auth client utility (e.g., `getAuthToken`).
    In the logic that executes on "END This Speech", after the final data payload is assembled, trigger an asynchronous `fetch` POST to `/api/confidence-coach/session`.
    Do not `await` this call on the main execution path in a way that blocks the user from seeing their score immediately (fire-and-forget).
    AVOID: Leaving the user waiting for the network request to finish before showing the results screen.
  </action>
  <verify>Ensure `fetch` exists in the finish state transition</verify>
  <done>UI reliably dispatches the data payload to the backend upon session completion without blocking.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] User schema has confidenceCoachStats.
- [ ] API endpoint exists and performs DB operations.
- [ ] Frontend triggers the POST request with the correctly structured payload upon session end.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
